---
title: "PC3"
format: html
editor: visual
---

## ANALISIS DE SUPERVIVENCIA DE DATA DE CANCER CERVICAL

### Se instalan los programas a utilizar

```{r}
install.packages("survival")
```

```{r}
install.packages("ggsurvfit")
```

```{r}
install.packages("broom")
install.packages("survminer")
```

### Cargamos los paquetes

```{r}
library(here)
library(rio)
library(survival)
```

```{r}
library(ggsurvfit)
```

```{r}
library(broom)
library(tidyverse)
library(lubridate)
library(survminer)
```

### Analizando datos de tiempo a evento

### -Estimaciones de supervivencia usando el método de Kaplan-Meier

Se carga el dataset de conocimiento y actitudes de cancer cervical, Este data tiene 218 pacientes y 18 variables

Se usara las variables de edad, parejas sexuales y antecedentes de ets.

```{r}
cancer_cervical <- import(here("DATA2", "conoc_actit_factor_cancer_cervical.csv"))
```

Vistazo al dataset

```{r}
cancer_cervical |> 
  select(edad, parejas_sex, antec_ets) |> 
  summary()
```

Ejemplo, Donde de la variable edad:

-Min: 25, es el menor edad registrada\
- 1st Qu: 38.25, significa que el 25% de los valores son menores o iguales a 38.25\
- Median: 48, significa que el 50% de los datos son \<= que 48 y el otro 50% son \>= 48\
- Mean: 45.41, El promedio de los valores se centran alrederor de 45.41\
-3rd Qu: 54, indica que el 75% de los valores son menores o iguales a 54\
- Max:67, Es el mayor dato registrado

## El desenlace en el análisis de supervivencia

Como no tenemos evento, entonces creamos un evento binario de la variable practica, asignandole a correcta=1 e incorrecta=0

```{r}
cancer_cervical$evento_binario <- ifelse(cancer_cervical$practica == "correcta", 1, 0)
```

Ahora:\
- edad= es mi tiempo\
- Evento binario creado= es el estado del evento (1 si la practica es correcta y 0 si no)

```{r}
Surv(cancer_cervical$edad, cancer_cervical$evento_binario)
```

Donde el simbolo + indica censura que el evento no ocurrio y es una practica incorrecta

Persona 1 → 53 años, **no tuvo el evento** (practica incorrecta)\
Persona 2 → 54 años, **no tuvo el evento** (practica incorrecta)**\
**Persona 3 → 26 años, **no tuvo el evento** (practica incorrecta)\
Persona 4 → 25 años, **sí tuvo el evento** (practica correcta)\
Persona 5 → 25 años, **sí tuvo el evento** (practica correcta)\
Persona 6 → 38 años, **sí tuvo el evento** (practica correcta)\
Persona 7 → 29 años, **no tuvo el evento** (practica incorrecta)

Ahora creamos una curva de supervivencia de Kaplan-Meier, combinando la variable edad y el evento binario creado.

```{r}
km = survfit(Surv(edad, evento_binario) ~ 1, data = cancer_cervical)
```

Donde aca podremos visualizar el objeto llamado km, con toda la informacion de tiempos observados, número de eventos, número de pacientes en riesgo, probabilidades de supervivencia acumulada,errores estándar e intervalos de confianza.

```{r}
str(km)
```

## Gráficos de Kaplan-Meier

```{r}
survfit2(Surv(edad, evento_binario) ~ 1, data = cancer_cervical) |>  
  ggsurvfit() +
  labs(
    x = "Edad",
    y = "Probabilidad de practica"
  ) +
  add_censor_mark()
```

Ahora añadimos intervalos de confianza de 95%

```{r}
survfit2(Surv(edad, evento_binario) ~ 1, data = cancer_cervical) |>  
  ggsurvfit() +
  labs(
    x = "Edad",
    y = "Probabilidad de practica"
  ) + 
  add_censor_mark() +
  add_confidence_interval() +
  add_risktable()
```

Interpretacion:

-   El eje **X** (`edad`) muestra la variable de tiempo o seguimiento; en este caso, la edad de las participantes. A medida que avanza la edad, observamos cómo cambia la probabilidad de mantener una práctica correcta.

-   El eje Y indica la probabilidad acumulada de mantener una práctica correcta (equivalente a “sobrevivir” sin que ocurra el evento = práctica incorrecta). Comienza en 1 (100%) y disminuye a medida que se acumulan los “eventos”, es decir, los casos con práctica incorrecta.

-   La línea negra es la estimación de la probabilidad de práctica correcta a lo largo de la edad.\
    Se observa que: Hasta los \~30 años, la probabilidad se mantiene alta (casi 100%). A partir de los 40 años, empieza a descender progresivamente. Hacia los 60 años, cae por debajo de 0.3 (es decir, menos del 30% mantienen una práctica correcta).

    Esto sugiere que las mujeres más jóvenes tienden a mantener mejores prácticas, mientras que la probabilidad de práctica correcta disminuye con la edad.

-   Cada símbolo “+” representa una observación censurada, es decir, una persona que no presentó el evento (práctica incorrecta) hasta esa edad o se perdió el seguimiento. Indican que el análisis incluye tanto eventos ocurridos como censurados, algo normal en estudios de supervivencia.

<!-- -->

-   La zona gris alrededor de la línea negra es el intervalo de confianza del 95%. Muestra la incertidumbre estadística: cuanto más ancha es el área gris, menos precisa es la estimación (por ejemplo, en edades altas, donde hay menos casos).

-   **At Risk:** número de mujeres que aún estaban “en riesgo” (es decir, aún mantenían práctica correcta) en cada punto de edad. Por ejemplo, a los 40 años quedan 159 en riesgo. A los 60 años, solo 13.

<!-- -->

-   **Events:** cantidad acumulada de eventos (casos con práctica incorrecta) ocurridos hasta ese punto. Por ejemplo, 75 eventos al final (mujeres que cambiaron a práctica incorrecta).

-   La curva de Kaplan-Meier muestra que la probabilidad de mantener una práctica correcta disminuye con la edad.\
    Las mujeres más jóvenes (menores de 35 años) presentan una mayor probabilidad de mantener una práctica adecuada, mientras que esta probabilidad se reduce significativamente en mujeres mayores de 50 años.\
    Esto podría indicar una relación inversa entre edad y adherencia a prácticas correctas de prevención o autocuidado.

## Estimación de la supervivencia a x años.

Como mi variable edad no esta en dias, si no en años entonces el argumento times=365.25 no lo analiza, por eso he suprimido esa parte. Y asi podremos visualizar la tabla completa de supervivencia, mostrando todas las edades en las que ocurrio al menos un evento, junto con el número de personas en riesgo y la probabilidad de "supervivencia" acumulada.

```{r}
summary(survfit(Surv(edad, evento_binario) ~ 1, data = cancer_cervical))
```

#### si quisieramos estimar la supervivencia a una edad específica Por ejemplo, a los **40 años**, podrías usar:

```{r}
summary(survfit(Surv(edad, evento_binario) ~ 1, data = cancer_cervical), times=40)
```

Se observó que a los 40 años la probabilidad de no haber presentado una práctica correcta fue del **91.7% (IC 95%: 87.8%–95.7%)**. Esto sugiere que la mayoría de las participantes aún no desarrollaban una práctica adecuada antes de esa edad, evidenciando una baja adopción temprana de conductas preventivas relacionadas con el cáncer cervicouterino.

```{r}
survfit2(Surv(edad, evento_binario) ~ 1, data = cancer_cervical) |>   ggsurvfit() +   labs(     x = "Edad",     y = "Probabilidad de Practica"   ) +    add_confidence_interval() +   add_risktable() +   add_quantile(x_value = 365.25, linewidth = .7) 
```

### Estimación mediana del tiempo de supervivencia

```{r}
survfit(Surv(time, status) ~ 1, data = lung)
```

```{r}
urvfit2(Surv(edad, evento_binario) ~ 1, data = cancer_cervical) |>
  ggsurvfit() +
  labs(
    x = "Edad",
    y = "Probabilidad de Practica"
  ) + 
  add_confidence_interval() +
  add_risktable() +
  add_quantile(y_value = 0.5, linewidth = .7)
```

# El modelo de regresión de Cox

```{r}
install.packages("gtsummary")
```

```{r}
library(gtsummary)
```

Continuamos con el dataset de cancer cervical el cual incluye información de 218 pacientes.

```{r}
head(cancer_cervical)
```

Entre las variables estan:

-edad = edad de las mujeres,\
-Actitud = positiva o negativa,\
-procedencia = urbano y rural.

Usaremos a la variable procedencia como la variable independiente de interés

```{r}
coxph(Surv(edad, actitud == "negativa") ~ procedencia, data = cancer_cervical)
```

El modelo de regresión de Cox mostró que la procedencia no tuvo un efecto estadísticamente significativo sobre la edad en que las mujeres presentan una actitud negativa frente al cáncer cervicouterino (HR = 1.26; IC 95% no significativo; p = 0.30).\

Aunque las participantes de zona urbana presentaron un 26% más de riesgo de tener una actitud negativa que las de zona rural, esta diferencia no fue suficiente para considerarse significativa.

```{r}
coxph(Surv(edad, actitud == "negativa") ~ procedencia, data = cancer_cervical) %>% 
  tbl_regression(exponentiate = TRUE) 
```

### Reporte para multiple variables

```{r}
tabla_cox <- cancer_cervical |>
  tbl_uvregression(
    include = c(procedencia, evento_binario, conocimiento, parejas_sex),
    y = Surv(edad, actitud == "negativa"),
    method = coxph,
    exponentiate = TRUE,
    conf.int = TRUE,
    hide_n = TRUE,
    add_estimate_to_reference_rows = FALSE,
    pvalue_fun = ~ style_pvalue(.x, digits = 3),
    estimate_fun = ~ style_number(.x, digits = 2),
    label = list(
      procedencia ~ "Procedencia",
      evento_binario ~ "Grado de practica",
      conocimiento ~ "Nivel de conocimiento",
      parejas_sex ~ "Numero de parejas sexuales")) |>
  bold_p(t = 0.05) |>
  modify_header(estimate = "**HR no ajustado**", p.value = "**Valor P**")
```

Imprimimos la tabla

```{r}
tabla_cox
```
