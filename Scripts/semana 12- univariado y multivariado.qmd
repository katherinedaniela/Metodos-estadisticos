---
title: "PRACTICA CALIFICADA 3- 2/2"
format: html
editor: visual
---

## Cargar los paquetes

```{r}
install.packages("performance")
install.packages("car")
install.packages("broom.helpers")
install.packages("here")
install.packages("rio")
install.packages("gtsummary")
install.packages("scales")
```

```{r}
library(tidyverse)
library(here)
library(rio)
library(car)
library(survival)
library(performance)
```

```{r}
library (broom.helpers)
library(gtsummary)
library(scales)
```

# Analisis univariado y multivariado en el analisis de datos

Cargando datos

```{r}
cancer_cervical <-import(here("DATA2", "conoc_actit_factor_cancer_cervical.csv"))
```

Un vistazo a los datos, con la opcion head muestra las primeras 6 lineas de nuestro dataset con sus variables

```{r}
head(cancer_cervical)
```

### El análisis univariado

De acuerdo a nuestra base de datos, se transformaron las variables *procedencia*, *antecedentes de ETS* y *actitud* en factores, ya que estas representan categorías cualitativas y requieren un tratamiento especial dentro de los modelos estadísticos.

Posteriormente, se definió una **categoría de referencia** para cada una de ellas mediante la función `relevel()`. Esta etapa es fundamental, ya que permite establecer un punto de comparación para los análisis posteriores. Para la variable *procedencia*, se eligió la categoría **“urbano”** como referencia; en *antecedentes de ETS*, se tomó como referencia la categoría **“no”**, al representar la ausencia del antecedente; y en la variable *actitud*, la categoría de base seleccionada fue **“positiva”**.

Finalmente, se aplicó la función `na.omit()` con el fin de eliminar los registros que presentaban valores faltantes en cualquiera de las variables incluidas. Esto asegura que los análisis posteriores se realicen sobre observaciones completas y consistentes. El código utilizado fue el siguiente:

```{r}
cancer_cervical1 <- cancer_cervical |> 
  mutate(procedencia = relevel(as.factor(procedencia), ref = "urbano"),
         antec_ets = relevel(as.factor(antec_ets), ref = "no"),
         actitud = relevel(as.factor(actitud), ref = "positiva")) |> 
  na.omit()
```

Para obtener la tabla del análisis univariado (regresión univariable), se utilizó la función `tbl_uvregression()`, la cual genera modelos logísticos no ajustados para cada variable incluida de manera independiente. Este enfoque evalúa la relación entre la variable dependiente (actitud) y cada una de las variables sociodemográficas por separado, lo que metodológicamente corresponde a un análisis bivariado

```{r}
tabla_reg_log_univ <- cancer_cervical1 |>
  tbl_uvregression(
    include = c(edad, e_marital, n_educacion, religion, procedencia,
                ocupacion, met_anticoncep),
    y = actitud,
    method = glm,
    method.args = list(family = binomial),
    exponentiate = TRUE,
    conf.int = TRUE,
    hide_n = TRUE,
    add_estimate_to_reference_rows = FALSE,
    pvalue_fun = ~ style_pvalue(.x, digits = 3),
    estimate_fun = ~ style_number(.x, digits = 2),
    label = list(
      edad ~ "Edad (años)",
      e_marital ~ "Estado Marital",
      n_educacion ~ "Nivel de educación",
      religion ~ "Religión",
      procedencia ~ "Procencia",
      ocupacion ~ "Ocupación",
      met_anticoncep ~ "Metodo anticonceptivo"
    )
  ) |>
  bold_labels() |>
  bold_p(t = 0.05) |>
  modify_header(estimate = "**OR no ajustado**", p.value = "**Valor P**")
```

En esta tabla, los resultados se expresan como odds ratios no ajustados (OR) con sus respectivos intervalos de confianza al 95% y valores p.

```{r}
tabla_reg_log_univ
```

Interpretación

En relación con la variable numérica *edad*, se observó un OR cercano a 1 (OR = 1.00; p = 0.948), lo que indica que el incremento de un año en la edad no modifica de manera relevante las probabilidades (odds) del evento estudiado. Además, el valor p no significativo confirma que no existe evidencia estadística de asociación.

Respecto a las variables categóricas, la mayoría no mostró asociación significativa con el desenlace. Por ejemplo, estado civil, religión y procedencia presentaron valores p mayores a 0.05, lo cual indica que sus categorías no se diferencian estadísticamente de su grupo de referencia.

Sin embargo, se identificaron **tres variables con asociaciones significativas**:

1.   **Nivel de educación:**\
    Las participantes con **educación superior** presentaron una reducción significativa en las probabilidades del evento en comparación con aquellas con educación primaria (OR = 0.10; p = 0.043). Esto sugiere que tener un mayor nivel educativo se asocia con menor riesgo del desenlace.

2.   **Ocupación:**\
    El ser *empleada* (OR = 0.06; p \< 0.001), *estudiante* (OR = 0.12; p \< 0.001) u *otro* (OR = 0.27; p = 0.040) se relacionó con **menores odds del evento** en comparación con ser ama de casa, lo que indica que la situación laboral puede influir de manera importante en la variable de interés.

3.   **Método anticonceptivo:**\
    Todas las categorías distintas a los anticonceptivos orales mostraron OR mayores a 1 y significativos. Por ejemplo:

    -   Ampolla trimestral: OR = 3.80

    -   Ampolla mensual: OR = 4.75

    -   DIU: OR = 20.90

    -   Implante: OR = 25.33

    -   No uso: OR = 11.79

    Esto implica que las mujeres que utilizan estos métodos (o no utilizan ninguno) presentan probabilidades significativamente mayores del evento en comparación con las usuarias de anticonceptivos orales.

4.   En conjunto, los resultados evidencian que **el nivel educativo, la ocupación y el método anticonceptivo** son los factores que presentan mayor relevancia en el análisis univariado, mientras que el resto de variables no mostró asociación estadísticamente significativa.

### El análisis multivariado

Para el análisis de regresión logística multivariada, se aplicó una estrategia de selección automática de variables utilizando tres enfoques: eliminación hacia atrás (*backward elimination*), selección hacia adelante (*forward selection*) y selección paso a paso (*stepwise selection)*.

**Paso 1. Ajuste del modelo inicial**

Ajustamos un modelo de regresión logística binaria que incluya todas las variables candidatas

```{r}
var_modelo = glm(   actitud ~ edad + e_marital + n_educacion + procedencia + ocupacion +      met_anticoncep + antec_ets,   data = cancer_cervical1,   family = binomial(link = "logit")   )
```

**Paso 2a. Realizamos la selección de variables** usando la técnica Eliminación hacia atrás (Backward elimination).

```{r}
multi_backward <- var_modelo |>   step(direction = "backward", trace = FALSE)
```

**Paso 2b. Realizamos la selección de variables** usando la técnica Selección hacia adelante (Forward selection).

```{r}
multi_forward <- var_modelo |>   step(direction = "forward", trace = FALSE)
```

**Paso 3c. Realizamos la selección de variables** usando la técnica Selección paso a paso (Stepwise selection).

```{r}
multi_stepwise <- var_modelo |>   step(direction = "both", trace = FALSE)
```

Los resultados de la selección de las variables para el modelo se han guardado en los objetos: multi_backward, multi_forward, y multi_stepwise. El siguiente paso es comparar los valores de AIC y la multicolinealidad entre las variables seleccionadas por cada uno de los modelos.

**Paso 3. Estimados el AIC para los modelos.**

Podemos visualizar el AIC y cuáles variables han sido seleccionadas en cada modelo, usando la función summary.

```{r}
summary(multi_backward)
```

```{r}
summary(multi_forward)
```

```{r}
summary(multi_stepwise)
```

Conclusion: Los modelos obtenidos mediante eliminación hacia atrás (backward) y selección paso a paso (stepwise) presentaron un mejor desempeño estadístico en comparación con el modelo completo. Ambos métodos lograron reducir el número de variables y obtener un menor AIC (235.42), lo que indica un mejor equilibrio entre ajuste y complejidad. Además, coincidieron en seleccionar las mismas variables significativas: nivel de educación, ocupación y método anticonceptivo. Por el contrario, el modelo completo —que incluía todas las variables sociodemográficas— no mejoró el ajuste (AIC: 244.03) y mantuvo predictores que no contribuían significativamente. Esto evidencia que los métodos backward y stepwise permiten identificar un modelo más parsimonioso y eficiente para explicar la actitud.

### Evaluación de colinealidad

Finalmente, evaluamos la colinealidad usando la función `check_collinearity()` del paquete `performance`.

```{r}
performance::check_collinearity(multi_backward, ci = NULL)
```

```{r}
performance::check_collinearity(multi_forward, ci = NULL)
```

```{r}
performance::check_collinearity(multi_stepwise, ci = NULL)
```

Conclusion: El análisis de multicolinealidad mostró que todos los predictores incluidos en los modelos presentan valores de VIF inferiores a 5, lo que indica ausencia de multicolinealidad preocupante. Las variables con mayor VIF fueron *ocupación* (VIF = 4.90 en el modelo completo) y *estado civil* (VIF = 3.36), aunque estos valores aún se encuentran dentro del rango aceptable. En los modelos reducidos, los VIF disminuyeron notablemente (entre 1.30 y 2.10), lo que refleja una estructura más estable y con menor correlación entre las variables. En conjunto, los resultados confirman que no existe multicolinealidad severa que comprometa la fiabilidad o interpretación de los coeficientes del modelo logístico.

### Modelo final 

Con base en los criterios de ajuste evaluados (AIC) y el análisis de colinealidad (VIF), se determinó que el modelo óptimo corresponde al obtenido mediante las técnicas de eliminación hacia atrás (*backward elimination*) y selección paso a paso (*stepwise selection*), ya que ambos generaron exactamente el mismo conjunto de predictores y presentaron el menor AIC.

El modelo final quedó conformado por tres variables independientes: **nivel de educación, ocupación y método anticonceptivo**, las cuales mostraron ausencia de multicolinealidad significativa y contribuyeron de manera estadísticamente relevante a la predicción de la actitud.

Estas variables serán reportadas y analizadas en detalle en el análisis multivariado final.

## Reporte del análisis univariado y multivariado

Tabla para los resultados de la regresión univariado (no ajustado)

```{r}
tabla_univ <- cancer_cervical1 |>
  tbl_uvregression(
    include = c(edad, e_marital, n_educacion, procedencia, ocupacion, met_anticoncep, antec_ets),
    y = actitud,
    method = glm,
    method.args = list(family = binomial),
    exponentiate = TRUE,
    conf.int = TRUE,
    hide_n = TRUE,
    add_estimate_to_reference_rows = FALSE,
    pvalue_fun = ~ style_pvalue(.x, digits = 3),
    estimate_fun = ~ style_number(.x, digits = 2),
    label = list(
      edad ~ "Edad (años)",
      e_marital ~ "Estado civil",
      n_educacion ~ "Nivel de educación",
      procedencia ~ "Procedencia",
      ocupacion ~ "Ocupación",
      met_anticoncep ~ "met_anticoncep",
      antec_ets ~ "Antecedente de ETS"
    )
  ) |>
  bold_labels() |>
  bold_p(t = 0.05) |>
  modify_header(estimate = "**OR**", p.value = "**Valor P**")
```

Tabla para los resultados de la regresión multivariable (ajustado)

```{r}
tabla_multi <- glm(
  actitud ~ edad + n_educacion + ocupacion + met_anticoncep,
  family = binomial(link = "logit"),
  data = cancer_cervical1
) |>
  tbl_regression(
    exponentiate = TRUE,
    conf.int = TRUE,
    pvalue_fun = ~ style_pvalue(.x, digits = 3),
    estimate_fun = ~ style_number(.x, digits = 2),
    label = list(
      edad ~ "Edad (años)",
      n_educacion ~ "Nivel de educación",
      ocupacion ~ "Ocupación",
      met_anticoncep ~ "Método anticonceptivo")
  ) |>
  bold_labels() |>
  bold_p(t = 0.05) |>
  modify_header(estimate = "**OR**", p.value = "**Valor P**")
```

La tabla final la construimos usando la función `tbl_merge()`. De modo que la tabla del análisis univariado o no ajustado y multivariado o ajustado, se muestren lado a lado.

```{r}
tabla_final <-    tbl_merge(     list(tabla_univ, tabla_multi),     tab_spanner = c("**Univariado**", "**Multivariado**")   )
```

```{r}
tabla_final
```

### **Interpretación**

En el modelo de regresión logística ajustado, la **ocupación** y el **método anticonceptivo** se asociaron de manera significativa con la actitud. Comparadas con las amas de casa, las mujeres **empleadas** presentan un 91% menor probabilidad de actitud negativa (OR = 0.09; IC95%: 0.02–0.29; p \< 0.001) y las **estudiantes** un 85% menor probabilidad (OR = 0.15; IC95%: 0.03–0.61; p = 0.010).

En cuanto al método anticonceptivo, el uso de **DIU** o **implante subdérmico** se asoció con un incremento muy significativo en las odds de actitud positiva (OR = 25.50; IC95%: 5.62–145.21; p \< 0.001 y OR = 31.79; IC95%: 5.35–248.31; p \< 0.001, respectivamente), mientras que otros métodos como ampolla mensual también mostraron asociación significativa.

Por otro lado, variables como **edad**, **estado civil**, **nivel de educación**, **procedencia** y **antecedente de ETS** no mostraron asociación estadísticamente significativa tras el ajuste por las demás variables del modelo.
